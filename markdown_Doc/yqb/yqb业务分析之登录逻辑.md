###YQB业务分析之登录逻辑
---

`url`: user/login

*业务逻辑：*

	1 手机号及密码的非空校验
	2 手机号的合法性检验
	3 账户是否存在或是否合法
	4 登录错误次数的校验：不超过5次，超过5次1小时后登录
	5 密码正确性校验
	6 构建用户token信息
	7 构建返回给客户端的数据模型
	

**手机号及密码的非空校验：**

StringTool.isNotEmpty()

**手机号的合法性检验：**

StringTool.isRightTel()

1 位数 == 11;

2 正则表达式, 匹配电话格式

参考：<http://baike.xsoftlab.net/view/207.html>

**账户是否存在或是否合法：**

从mysql取出`BaseUserInfo`,校验是否存在并对`status`进行判断

**用户状态 status:**

-10: 注销, 用户信息在后台清空

0: 正常

-20:黑名单, 前端无法登录，用户信息在后台可以查看

-30: 冻结, 前端可以登录，只能查询，不能操作交易和资金

目前代码中只针对status=-20进行了校验

**登录错误次数的校验：不超过5次，超过5次1小时后登录**：

从mongodb`(为什么不用redis?)`中获取最近5次登录的记录`LogInfo`，根据`isSuccessed`计算失败的次数.

		1 这里计算失败次数的算法存在硬编码，需要重构
		2 貌似没有实现1小时后可重新登录，应该在1小时后清空数据库或redis的登录记录

**密码正确性校验:**

无论正确还是错误，都在mongodb中保存登录信息`LogInfo`;

错误：根据已经错误的次数反馈信息给客户端

正确：

1 更新`BaseUserInfo`的最新登录时间等信息

2 构建`token`：TokenTools,并在在mongodb中更新token

	token相关信息保存在db.idToken集合当中

3 构建`UserInfoVo`:根据 BaseUserInfo,进行表查询，补充模型字段

4 查询昵称更改情况

	昵称的处理有待进一步研究






	 









 


